= buf3pd
:toc: macro
:toclevels: 3
:toc-title: Table of Contents

toc::[]

IMPORTANT: *WORK IN PROGRESS*: This project is currently in development. This document outlines the vision and usage for the tool.

== Overview

buf3pd (Buf Third-Party Dependencies) is a command-line tool for managing third-party Protocol Buffer (protobuf) dependencies in Buf projects. It simplifies the process of fetching, updating, and managing external protobuf dependencies from Git repositories.

== Why buf3pd?

=== Challenges with Protobuf Dependencies

Working with external protobuf dependencies presents several challenges:

* Manual cloning and management of Git repositories
* Tracking versions and commits of dependencies
* Ensuring reproducible builds across environments
* Managing path prefixes and directory structures
* Dependency conflict resolution

=== Solution

buf3pd addresses these challenges by:

* Providing declarative configuration in your buf.yaml file
* Automatically cloning and updating Git repositories
* Generating a lock file to track exact commits and hashes
* Supporting path filtering to include only needed files
* Enabling prefix management for import path manipulation

== Usage

=== Basic Configuration

Add a `buf3pd` section to your `buf.yaml` file:

[source,yaml]
----
# yaml-language-server: $schema=https://json.schemastore.org/buf.json

version: v2
# ... standard buf config ...

---
# yaml-language-server: $schema=https://json.schemastore.org/any.json

buf3pd:
    path: gen/buf3pd
    deps:
      - type: git
        repo: github.com/bufbuild/protovalidate
        path: proto/protovalidate
        ref: heads/main
      - type: git
        repo: github.com/googleapis/googleapis
        path: .
        filter:
          - "google/{api,longrunning,rpc,servicecontrol,logging,type}/**"
        ref: heads/master
----

=== Command Line Interface

[source,bash]
----
# Install dependencies defined in buf.yaml
buf3pd install

# Update all dependencies to latest versions (respecting refs)
buf3pd update

# Clean all downloaded dependencies
buf3pd clean

# Show status of dependencies
buf3pd status
----

=== Lock File

buf3pd generates a `buf3pd.lock` file that tracks the exact state of your dependencies:

[source,yaml]
----
# Generated by buf3pd. DO NOT EDIT.
version: v2
deps:
    - repo: github.com/bufbuild/protovalidate
      path: proto/protovalidate
      ref: heads/main
      digest: 58b59af8ca3bc462683d24f92187783146187e5876a940d9bfbb777b5db558c2
      prefix: ""
      metadata:
        commit: c9f2cb4e4aa2676f9eaea044d36001a2676ef124
        type: git
----

== Configuration Options

=== Global Options

[cols="1,2,1"]
|===
|Option |Description |Default

|`path`
|Directory where dependencies will be stored
|`gen/buf3pd`
|===

=== Dependency Options

[cols="1,2,1"]
|===
|Option |Description |Default

|`type`
|Dependency source type (currently only `git` is supported)
|Required

|`repo`
|Repository URL/path (e.g., `github.com/org/repo`)
|Required

|`path`
|Path within the repository to the protobuf files
|`.`

|`ref`
|Git reference (branch, tag, or commit)
|`heads/main`

|`filter`
|List of glob patterns to include
|Include all files

|`prefix`
|Import path prefix to prepend
|No prefix
|===

== Architecture

buf3pd follows a simple architecture to manage protobuf dependencies:

=== Core Components

* *Parser*: Reads and validates buf.yaml configuration
* *Git Provider*: Handles git operations (clone, fetch, checkout)
* *Lock File Manager*: Generates and updates the lock file
* *File System Manager*: Handles copying and filtering files

== Development

=== Building from Source

[source,bash]
----
# Clone the repository
git clone https://github.com/walteh/buf3pd.git
cd buf3pd

# Build the binary
go build -o buf3pd ./cmd/buf3pd
----

=== Running Tests

[source,bash]
----
go test ./...
----

== Project Roadmap

* [ ] Support for additional dependency sources (HTTP, local paths)
* [ ] Improved conflict resolution
* [ ] Dependency graph visualization
* [ ] Performance optimizations for large repositories
* [ ] Integration with buf registry 